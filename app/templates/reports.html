{% extends "base.html" %}

{% block title %}Generate Reports - ThreatIntellAI{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-danger text-white">
                <h4 class="card-title mb-0">
                    <i class="fas fa-file-pdf"></i>
                    Generate Security Report
                </h4>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Create professional security reports for school administration, 
                    incident documentation, or compliance requirements.
                </p>

                <form id="reportForm" onsubmit="generateReport(event)">
                    <div class="mb-3">
                        <label for="report_title" class="form-label">Report Title</label>
                        <input type="text" class="form-control" id="report_title" name="title" 
                               placeholder="e.g., Monthly Security Assessment" required>
                    </div>

                    <div class="mb-3">
                        <label for="school_name" class="form-label">School Name</label>
                        <input type="text" class="form-control" id="school_name" name="school_name" 
                               placeholder="Enter your school name" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="report_type" class="form-label">Report Type</label>
                                <select class="form-select" id="report_type" name="report_type" required>
                                    <option value="incident">Security Incident</option>
                                    <option value="security_scan">Security Scan</option>
                                    <option value="log_analysis">Log Analysis</option>
                                    <option value="comprehensive">Comprehensive Assessment</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="report_format" class="form-label">Format</label>
                                <select class="form-select" id="report_format" name="format" required>
                                    <option value="pdf">PDF Document</option>
                                    <option value="html">HTML Web Page</option>
                                    <option value="both">Both Formats</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Report Includes:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Executive summary with risk assessment</li>
                            <li>Detailed threat findings and analysis</li>
                            <li>AI-powered security explanations</li>
                            <li>Actionable recommendations for school staff</li>
                            <li>Professional school branding</li>
                        </ul>
                    </div>

                    <button type="submit" class="btn btn-danger btn-lg w-100" id="generateButton">
                        <i class="fas fa-file-pdf"></i>
                        Generate Report
                    </button>
                </form>

                <div id="result" class="mt-4" style="display: none;"></div>
            </div>
        </div>

        <!-- Sample Reports -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-download"></i>
                    Quick Report Templates
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100" onclick="fillTemplate('Weekly Security Scan', 'pdf')">
                            Weekly Scan (PDF)
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-success w-100" onclick="fillTemplate('Incident Response Report', 'html')">
                            Incident Report (HTML)
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-danger w-100" onclick="fillTemplate('Comprehensive Security Audit', 'both')">
                            Full Audit (Both)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function fillTemplate(title, format) {
    document.getElementById('report_title').value = title;
    document.getElementById('report_format').value = format;
    document.getElementById('school_name').value = 'Springfield Elementary School';
}

async function generateReport(event) {
    event.preventDefault();
    
    const form = event.target;
    const button = document.getElementById('generateButton');
    const resultDiv = document.getElementById('result');
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    button.disabled = true;
    resultDiv.style.display = 'none';
    
    try {
        const formData = new FormData(form);
        const response = await fetch('/api/generate-report', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <strong>Report Generated Successfully!</strong>
                    <div class="mt-2">
                        <p><strong>Report ID:</strong> ${data.result.report_id}</p>
                        <p><strong>Format:</strong> ${data.result.format}</p>
                        <p><strong>File Size:</strong> ${(data.result.file_size / 1024).toFixed(2)} KB</p>
                    </div>
                    <div class="mt-3">
                        <a href="${data.result.download_url}" class="btn btn-success" target="_blank">
                            <i class="fas fa-download"></i> Download Report
                        </a>
                        <button onclick="generateReport(event)" class="btn btn-outline-primary">
                            <i class="fas fa-plus"></i> Create Another
                        </button>
                    </div>
                </div>
            `;
            resultDiv.style.display = 'block';
        } else {
            showError(data.error || 'Report generation failed. Please try again.');
        }
    } catch (error) {
        showError('Network error. Please check your connection.');
    } finally {
        // Reset button
        button.innerHTML = '<i class="fas fa-file-pdf"></i> Generate Report';
        button.disabled = false;
    }
}

function showError(message) {
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Error:</strong> ${message}
        </div>
    `;
    resultDiv.style.display = 'block';
}
</script>
{% endblock %}